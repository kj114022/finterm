name: Release

# Trigger: Push a version tag like v0.4.0
# Usage: git tag v0.4.0 && git push origin v0.4.0

on:
  push:
    tags:
      - 'v*'

env:
  CARGO_TERM_COLOR: always

jobs:
  # Build for all platforms
  build:
    name: Build ${{ matrix.target }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: x86_64-apple-darwin
            os: macos-13  # Intel Mac
            name: finterm-macos-x86_64
            archive: tar.gz
          - target: aarch64-apple-darwin
            os: macos-14  # ARM Mac (M1/M2)
            name: finterm-macos-aarch64
            archive: tar.gz
          - target: x86_64-unknown-linux-gnu
            os: ubuntu-latest
            name: finterm-linux-x86_64
            archive: tar.gz

    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}
      
      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        with:
          key: ${{ matrix.target }}
      
      - name: Build release
        run: cargo build --release --target ${{ matrix.target }}
      
      - name: Package
        run: |
          cd target/${{ matrix.target }}/release
          tar -czvf ../../../${{ matrix.name }}.${{ matrix.archive }} finterm
          cd ../../..
          shasum -a 256 ${{ matrix.name }}.${{ matrix.archive }} > ${{ matrix.name }}.sha256
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.name }}
          path: |
            ${{ matrix.name }}.${{ matrix.archive }}
            ${{ matrix.name }}.sha256

  # Create GitHub Release with all binaries
  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      version: ${{ steps.get_version.outputs.version }}
      aarch64_sha: ${{ steps.get_sha.outputs.aarch64_sha }}
      x86_64_sha: ${{ steps.get_sha.outputs.x86_64_sha }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Get version from tag
        id: get_version
        run: echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
      
      - name: Get SHA256 hashes
        id: get_sha
        run: |
          echo "aarch64_sha=$(cat artifacts/finterm-macos-aarch64/finterm-macos-aarch64.sha256 | awk '{print $1}')" >> $GITHUB_OUTPUT
          echo "x86_64_sha=$(cat artifacts/finterm-macos-x86_64/finterm-macos-x86_64.sha256 | awk '{print $1}')" >> $GITHUB_OUTPUT
      
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          name: ${{ steps.get_version.outputs.version }}
          body: |
            ## FinTerm ${{ steps.get_version.outputs.version }}
            
            ### Installation
            
            **Homebrew (macOS):**
            ```bash
            brew tap kj114022/finterm
            brew install finterm
            ```
            
            **Manual:**
            Download the appropriate binary for your platform below.
            
            ### SHA256 Checksums
            - macOS ARM (M1/M2): `${{ steps.get_sha.outputs.aarch64_sha }}`
            - macOS Intel: `${{ steps.get_sha.outputs.x86_64_sha }}`
          files: |
            artifacts/**/*.tar.gz
            artifacts/**/*.sha256
          generate_release_notes: true

  # Auto-update Homebrew formula
  homebrew:
    name: Update Homebrew
    needs: release
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          repository: kj114022/homebrew-finterm
          token: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          path: homebrew-tap
      
      - name: Update formula
        run: |
          VERSION="${{ needs.release.outputs.version }}"
          AARCH64_SHA="${{ needs.release.outputs.aarch64_sha }}"
          X86_64_SHA="${{ needs.release.outputs.x86_64_sha }}"
          
          cat > homebrew-tap/Formula/finterm.rb << EOF
          class Finterm < Formula
            desc "Fast terminal news aggregator for Hacker News, Reddit, arXiv, and financial markets"
            homepage "https://github.com/kj114022/finterm"
            version "${VERSION#v}"
            license "AGPL-3.0"

            on_macos do
              on_arm do
                url "https://github.com/kj114022/finterm/releases/download/${VERSION}/finterm-macos-aarch64.tar.gz"
                sha256 "${AARCH64_SHA}"
              end
              on_intel do
                url "https://github.com/kj114022/finterm/releases/download/${VERSION}/finterm-macos-x86_64.tar.gz"
                sha256 "${X86_64_SHA}"
              end
            end

            def install
              bin.install "finterm"
            end

            test do
              assert_match "finterm", shell_output("#{bin}/finterm --version")
            end
          end
          EOF
      
      - name: Commit and push
        run: |
          cd homebrew-tap
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add Formula/finterm.rb
          git commit -m "Update finterm to ${{ needs.release.outputs.version }}"
          git push
